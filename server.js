import express from "express";
import path from "path";
import { fileURLToPath } from "url";
import dotenv from 'dotenv';
import session from 'express-session';
import pgSession from 'connect-pg-simple';
const PgSession = pgSession(session);
import passport from 'passport';
import SteamStrategy from 'passport-steam';
import pkg from "pg";
import bcrypt from 'bcryptjs';
import steamRoutes from './routes/steam.js';
const { Pool } = pkg;


// test-env.js (en la ra√≠z)
import 'dotenv/config';
console.log('STEAM_API_KEY:', process.env.STEAM_API_KEY);
console.log('DB_HOST:', process.env.DB_HOST);

// En steamService.js
import axios from 'axios';
import https from 'https';

// Solo para desarrollo local
const httpsAgent = process.env.NODE_ENV !== 'production'
    ? new https.Agent({ rejectUnauthorized: false })
    : undefined;

const axiosInstance = axios.create({
    httpsAgent,
    timeout: 10000
});

// Usa axiosInstance en lugar de axios para las llamadas a Steam
// Cargar variables de entorno
dotenv.config();

// Configuraci√≥n para ES Modules
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Inicializar Express
const app = express();
const PORT = process.env.PORT || 3000;

// üî• MIDDLEWARES PRIMERO - MUY IMPORTANTE EL ORDEN
console.log('üîß Configurando middlewares...');

// Body parsing DEBE ir ANTES de las rutas
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// Static files
app.use(express.static('public'));
app.use(express.static(path.join(__dirname, "public")));
app.use('/javascripts', express.static(path.join(__dirname, 'public', 'javascripts')));
app.use('/stylesheets', express.static(path.join(__dirname, 'public', 'stylesheets')));
app.use('/images', express.static(path.join(__dirname, 'public', 'images')));
app.use('/api/steam', steamRoutes);
// Configurar base de datos
const pool = new Pool({
    connectionString: process.env.DATABASE_URL,
    ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,
});

// Middleware de debug para ver qu√© llega en req.body
app.use('/login', (req, res, next) => {
    console.log('üîç DEBUG LOGIN - Content-Type:', req.get('Content-Type'));
    console.log('üîç DEBUG LOGIN - req.body:', req.body);
    console.log('üîç DEBUG LOGIN - req.method:', req.method);
    next();
});

// Sesiones
app.use(session({
    store: new PgSession({
        pool: pool,
        tableName: 'session'
    }),
    secret: process.env.SESSION_SECRET || 'fallback-secret-key-super-segura-123456789',
    resave: false,
    saveUninitialized: false,
    cookie: {
        secure: false, // Cambiado temporalmente para debug
        maxAge: 24 * 60 * 60 * 1000,
        httpOnly: true
    }
}));

// Passport
app.use(passport.initialize());
app.use(passport.session());

// Steam Strategy
if (process.env.STEAM_API_KEY) {
    console.log('üéÆ Configurando Steam Strategy...');
    passport.use(new SteamStrategy({
        returnURL: process.env.STEAM_RETURN_URL || `http://localhost:${PORT}/auth/steam/return`,
        realm: process.env.STEAM_REALM || `http://localhost:${PORT}/`,
        apiKey: process.env.STEAM_API_KEY
    }, async (identifier, profile, done) => {
        try {
            const steamUser = {
                steam_id: profile.id,
                nombre_usuario: profile.displayName,
                nombre: profile.displayName,
                steam_avatar: profile.photos[2]?.value || profile.photos[0]?.value || ''
            };
            return done(null, steamUser);
        } catch (error) {
            return done(error, null);
        }
    }));
}

// Serializaci√≥n
passport.serializeUser((user, done) => {
    done(null, user);
});

passport.deserializeUser((user, done) => {
    done(null, user);
});

// üî• RUTAS - DESPU√âS DE TODOS LOS MIDDLEWARES

console.log('üõ£Ô∏è  Configurando rutas...');

// Login de supervisores Y jugadores
app.post('/login', async (req, res) => {
    try {
        console.log('üîë Iniciando sesi√≥n...');
        console.log('üì¶ req.body recibido:', JSON.stringify(req.body, null, 2));

        // Verificar que req.body existe
        if (!req.body) {
            console.log('‚ùå req.body es undefined o null');
            return res.status(400).json({
                success: false,
                message: 'No se recibieron datos en el cuerpo de la petici√≥n'
            });
        }

        const { usuario, password } = req.body;

        console.log('üë§ Usuario:', usuario);
        console.log('üîê Password recibido:', password ? 'S√ç' : 'NO');

        if (!usuario || !password) {
            console.log('‚ùå Faltan datos obligatorios');
            return res.status(400).json({
                success: false,
                message: 'Usuario y contrase√±a son obligatorios'
            });
        }

        // Buscar usuario por nombre_usuario o email
        console.log('üîç Buscando usuario en BD...');
        const result = await pool.query(
            `SELECT * FROM usuarios
             WHERE nombre_usuario = $1 OR email = $1`,
            [usuario]
        );

        console.log('üìä Resultados de b√∫squeda:', result.rows.length);

        if (result.rows.length === 0) {
            return res.status(400).json({
                success: false,
                message: 'Usuario no encontrado'
            });
        }

        const user = result.rows[0];
        console.log('üë§ Usuario encontrado:', {
            id: user.id,
            nombre_usuario: user.nombre_usuario,
            rol: user.rol,
            tiene_password: !!user.password
        });

        // Validar contrase√±a
        const match = await bcrypt.compare(password, user.password || '');
        console.log('üîê Contrase√±a v√°lida:', match);

        if (!match) {
            return res.status(400).json({
                success: false,
                message: 'Contrase√±a incorrecta'
            });
        }

        // Actualizar √∫ltimo login
        await pool.query(
            `UPDATE usuarios SET ultimo_login = CURRENT_TIMESTAMP WHERE id = $1`,
            [user.id]
        );

        // Guardar en sesi√≥n
        req.session.user = {
            id: user.id,
            nombre_usuario: user.nombre_usuario,
            rol: user.rol,
            steamId: user.steam_id,
            avatar: user.steam_avatar
        };

        console.log('‚úÖ Login exitoso, redirigiendo...');

        const redirectUrl = user.rol === 'supervisor'
            ? '/dashboard-supervisor.html'
            : user.steam_id
                ? `/dashboard-jugador.html?steam_id=${user.steam_id}`
                : '/dashboard-jugador.html';

        return res.json({
            success: true,
            message: 'Login exitoso',
            user: {
                id: user.id,
                nombre_usuario: user.nombre_usuario,
                rol: user.rol,
                steamId: user.steam_id
            },
            redirectUrl: redirectUrl
        });

    } catch (error) {
        console.error('‚ùå Error en login:', error);
        console.error('‚ùå Stack trace:', error.stack);
        return res.status(500).json({
            success: false,
            message: 'Error interno del servidor',
            debug: process.env.NODE_ENV === 'development' ? error.message : undefined
        });
    }
});

// Registro de supervisores
app.post('/registro', async (req, res) => {
    try {
        console.log('üìù Iniciando registro...');
        console.log('üì¶ req.body:', JSON.stringify(req.body, null, 2));

        const { nombre, usuario, correo, telefono, cedula, rol, password, confirmPassword } = req.body;

        if (!nombre || !usuario || !correo || !telefono || !cedula || !rol || !password) {
            return res.status(400).json({
                success: false,
                message: 'Todos los campos son obligatorios'
            });
        }

        if (password !== confirmPassword) {
            return res.status(400).json({
                success: false,
                message: 'Las contrase√±as no coinciden'
            });
        }

        if (rol !== 'supervisor') {
            return res.status(400).json({
                success: false,
                message: 'Solo se permite registro tradicional para supervisores'
            });
        }

        const existingUser = await checkUserExists('nombre_usuario', usuario);
        if (existingUser) {
            return res.status(400).json({
                success: false,
                message: 'El nombre de usuario ya est√° en uso'
            });
        }

        const existingEmail = await checkUserExists('email', correo);
        if (existingEmail) {
            return res.status(400).json({
                success: false,
                message: 'El correo ya est√° registrado'
            });
        }

        const hashedPassword = await bcrypt.hash(password, 12);
        const newUser = await insertSupervisor(nombre, usuario, correo, telefono, cedula, hashedPassword);

        console.log('‚úÖ Usuario registrado exitosamente');

        res.json({
            success: true,
            message: 'Supervisor registrado exitosamente',
            redirectUrl: '/login.html'
        });

    } catch (error) {
        console.error('‚ùå Error en registro:', error);
        res.status(500).json({
            success: false,
            message: 'Error interno del servidor'
        });
    }
});

// RUTAS DE STEAM
app.use('/api/steam', steamRoutes);

// Ruta espec√≠fica que usa el frontend para obtener URL de Steam
app.get('/api/steam/auth-url', (req, res) => {
    if (!process.env.STEAM_API_KEY) {
        return res.status(400).json({
            success: false,
            message: 'Steam no est√° configurado en el servidor'
        });
    }

    const authUrl = '/auth/steam';
    res.json({
        success: true,
        url: authUrl
    });
});

// Steam OAuth routes
if (process.env.STEAM_API_KEY) {
    app.get('/auth/steam', passport.authenticate('steam'));

    app.get('/auth/steam/return',
        passport.authenticate('steam', { failureRedirect: '/login.html' }),
        async (req, res) => {
            try {
                console.log('üéÆ Steam callback recibido:', req.user);

                const existingUser = await checkUserExists('steam_id', req.user.steam_id);

                if (!existingUser) {
                    console.log('üë§ Creando nuevo usuario de Steam...');
                    await insertJugador(
                        req.user.steam_id,
                        req.user.nombre_usuario,
                        req.user.nombre,
                        req.user.steam_avatar
                    );
                }

                // Establecer sesi√≥n para el usuario de Steam
                req.session.user = {
                    steamId: req.user.steam_id,
                    nombre_usuario: req.user.nombre_usuario,
                    avatar: req.user.steam_avatar,
                    rol: 'jugador'
                };

                console.log('‚úÖ Sesi√≥n Steam establecida, redirigiendo...');
                res.redirect(`/dashboard-jugador.html?steam_id=${req.user.steam_id}`);
            } catch (error) {
                console.error('‚ùå Error Steam callback:', error);
                res.redirect('/login.html?error=steam-error');
            }
        }
    );
}

// Logout
app.post('/api/logout', (req, res) => {
    req.session.destroy((err) => {
        if (err) {
            return res.status(500).json({ success: false, message: 'Error al cerrar sesi√≥n' });
        }
        res.json({ success: true, message: 'Sesi√≥n cerrada correctamente' });
    });
});

// Middleware para proteger rutas del dashboard
const requireAuth = (req, res, next) => {
    if (!req.session.user) {
        return res.redirect('/login.html');
    }
    next();
};

// Rutas b√°sicas
app.get("/", (req, res) => {
    res.sendFile(path.join(__dirname, "public", "index.html"));
});

app.get("/registro.html", (req, res) => {
    res.sendFile(path.join(__dirname, "public", "registro.html"));
});

app.get("/login.html", (req, res) => {
    res.sendFile(path.join(__dirname, "public", "login.html"));
});

app.get("/dashboard-jugador.html", requireAuth, (req, res) => {
    res.sendFile(path.join(__dirname, "public", "dashboard-jugador.html"));
});

app.get("/dashboard-supervisor.html", requireAuth, (req, res) => {
    if (req.session.user.rol !== 'supervisor') {
        return res.redirect('/login.html');
    }
    res.sendFile(path.join(__dirname, "public", "dashboard-supervisor.html"));
});

// Health check
app.get("/health", (req, res) => {
    res.json({
        status: "OK",
        timestamp: new Date().toISOString(),
        env: process.env.NODE_ENV
    });
});

// Test route
app.get("/test", (req, res) => {
    res.send("üöÄ El servidor est√° vivo y responde correctamente");
});

// Error handler - 404
app.use((req, res) => {
    console.log('‚ùå 404 - Ruta no encontrada:', req.url);
    res.status(404).json({ error: 'P√°gina no encontrada', path: req.url });
});

// Error handler general
app.use((error, req, res, next) => {
    console.error('‚ùå Error general:', error);
    res.status(500).json({
        error: 'Error interno del servidor',
        message: process.env.NODE_ENV === 'development' ? error.message : 'Error interno'
    });
});

// FUNCIONES DE BASE DE DATOS
async function initializeDatabase() {
    try {
        console.log('üóÉÔ∏è  Inicializando base de datos...');

        // Test connection first
        await pool.query("SELECT 1");
        console.log("‚úÖ Conexi√≥n DB establecida");

        // Tabla usuarios
        const checkUsuarios = await pool.query(`
            SELECT EXISTS (
                SELECT FROM information_schema.tables
                WHERE table_schema = 'public'
                  AND table_name = 'usuarios'
            );
        `);

        if (!checkUsuarios.rows[0].exists) {
            await pool.query(`
                CREATE TABLE usuarios (
                                          id SERIAL PRIMARY KEY,
                                          nombre VARCHAR(100),
                                          nombre_usuario VARCHAR(50) UNIQUE,
                                          email VARCHAR(100) UNIQUE,
                                          telefono VARCHAR(15),
                                          cedula VARCHAR(20),
                                          rol VARCHAR(20) NOT NULL CHECK (rol IN ('jugador', 'supervisor')),
                                          password VARCHAR(255),
                                          steam_id VARCHAR(50) UNIQUE,
                                          steam_avatar TEXT,
                                          activo BOOLEAN DEFAULT true,
                                          ultimo_login TIMESTAMP,
                                          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )
            `);
            console.log("‚úÖ Tabla usuarios creada");
        } else {
            console.log("‚ÑπÔ∏è  Tabla usuarios ya existe");
        }

        // Tabla session
        const checkSession = await pool.query(`
            SELECT EXISTS (
                SELECT FROM information_schema.tables
                WHERE table_schema = 'public'
                  AND table_name = 'session'
            );
        `);

        if (!checkSession.rows[0].exists) {
            await pool.query(`
                CREATE TABLE "session" (
                                           "sid" varchar NOT NULL COLLATE "default",
                                           "sess" json NOT NULL,
                                           "expire" timestamp(6) NOT NULL,
                                           CONSTRAINT "session_pkey" PRIMARY KEY ("sid")
                )
            `);

            await pool.query(`CREATE INDEX "IDX_session_expire" ON "session" ("expire")`);
            console.log("‚úÖ Tabla session creada");
        } else {
            console.log("‚ÑπÔ∏è  Tabla session ya existe");
        }

    } catch (err) {
        console.error("‚ùå Error DB:", err.message);
        throw err;
    }
}

async function checkUserExists(field, value) {
    try {
        const allowedFields = ['nombre_usuario', 'email', 'steam_id', 'cedula'];
        if (!allowedFields.includes(field)) {
            return null;
        }
        const res = await pool.query(`SELECT * FROM usuarios WHERE ${field} = $1`, [value]);
        return res.rows[0] || null;
    } catch (err) {
        console.error("Error verificando usuario:", err.message);
        return null;
    }
}

async function insertSupervisor(nombre, nombre_usuario, email, telefono, cedula, password) {
    try {
        const res = await pool.query(
            `INSERT INTO usuarios (nombre, nombre_usuario, email, telefono, cedula, rol, password)
             VALUES ($1, $2, $3, $4, $5, 'supervisor', $6) RETURNING id, nombre_usuario, email, rol`,
            [nombre, nombre_usuario, email, telefono, cedula, password]
        );
        return res.rows[0];
    } catch (err) {
        if (err.code === '23505') {
            throw new Error('El usuario o email ya existe');
        }
        throw err;
    }
}

async function insertJugador(steam_id, nombre_usuario, nombre, steam_avatar) {
    try {
        const existing = await pool.query('SELECT * FROM usuarios WHERE steam_id = $1', [steam_id]);

        if (existing.rows.length > 0) {
            await pool.query('UPDATE usuarios SET ultimo_login = CURRENT_TIMESTAMP WHERE steam_id = $1', [steam_id]);
            return existing.rows[0];
        }

        const res = await pool.query(
            `INSERT INTO usuarios (steam_id, nombre_usuario, nombre, rol, steam_avatar)
             VALUES ($1, $2, $3, 'jugador', $4) RETURNING id, nombre_usuario, rol`,
            [steam_id, nombre_usuario, nombre, steam_avatar]
        );
        return res.rows[0];
    } catch (err) {
        console.error("Error insertando jugador:", err.message);
        throw err;
    }
}

// Inicializar servidor
const startServer = async () => {
    try {
        console.log('üöÄ Iniciando SafePlay Server...');

        await initializeDatabase();

        app.listen(PORT, () => {
            console.log(`üåü ========================================`);
            console.log(`üöÄ Servidor SafePlay INICIADO`);
            console.log(`üìç Puerto: ${PORT}`);
            console.log(`üåç Entorno: ${process.env.NODE_ENV || 'development'}`);
            console.log(`üéÆ Steam API: ${process.env.STEAM_API_KEY ? 'Configurada ‚úÖ' : 'No configurada ‚ùå'}`);
            console.log(`üíæ Database: ${process.env.DATABASE_URL ? 'Conectada ‚úÖ' : 'No configurada ‚ùå'}`);
            console.log(`üîê Session Secret: ${process.env.SESSION_SECRET ? 'Configurado ‚úÖ' : 'Usando fallback ‚ö†Ô∏è'}`);
            console.log(`üåü ========================================`);
        });

    } catch (error) {
        console.error('‚ùå Error cr√≠tico iniciando servidor:', error);
        process.exit(1);
    }
};

startServer();

export default app;